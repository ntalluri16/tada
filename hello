#!/bin/bash

# ======== CONFIGURATION ========
ACCESS_TOKEN="YOUR_ACCESS_TOKEN"
GROUP_ID="YOUR_GROUP_ID"
DATASET_ID="YOUR_DATASET_ID"
POLL_INTERVAL=15  # seconds between checks

# ======== FUNCTION TO GET STATUS ========
get_status() {
  RESPONSE=$(curl -s -X GET \
    -H "Authorization: Bearer $ACCESS_TOKEN" \
    -H "Content-Type: application/json" \
    "https://api.powerbi.com/v1.0/myorg/groups/$GROUP_ID/datasets/$DATASET_ID/refreshes?\$top=1")

  # Extract status from response
  STATUS=$(echo "$RESPONSE" | jq -r '.value[0].status')
  echo "$RESPONSE" > last_response.json  # Optional: log response
  echo "$STATUS"
}

# ======== POLLING LOOP ========
echo "‚è≥ Waiting for dataset refresh to complete..."

while true; do
  STATUS=$(get_status)

  if [[ "$STATUS" == "Completed" ]]; then
    echo "‚úÖ Refresh completed successfully."
    exit 0
  elif [[ "$STATUS" == "Failed" ]]; then
    echo "‚ùå Refresh failed. Check details in last_response.json"
    exit 1
  elif [[ "$STATUS" == "Unknown" || "$STATUS" == "null" ]]; then
    echo "‚ö†Ô∏è  No recent refresh status found. Waiting..."
  else
    echo "üîÑ Current status: $STATUS"
  fi

  sleep $POLL_INTERVAL
done
